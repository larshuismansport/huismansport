<!doctype html>
<html lang="nl">
  <head>
    <meta charset="utf-8">
    <title>{% if assignment %}Bewerk Opdracht{% else %}Nieuwe Opdracht{% endif %} | Teamwear & Drukwerk</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      /* Algemene styling voor de zoekfunctie */
      #customerSuggestions {
        position: absolute;
        z-index: 1000;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ccc;
        background: white;
        display: none;
      }
      #customerSuggestions .suggestion-item {
        padding: 5px 10px;
        cursor: pointer;
      }
      #customerSuggestions .suggestion-item:hover {
        background: #f0f0f0;
      }
      .position-relative {
        position: relative;
      }
      /* Klein lettertype */
      body, .form-label, p {
        font-size: 0.9rem;
      }
      /* Container en blokken */
      .blocks-section {
        background-color: white;
        padding: 2rem;
      }
      /* Card styling */
      .card {
        border: none;
      }
      .card-body {
        background-color: #f7f7f7;
        padding: 1rem;
        overflow: hidden;
        position: relative;
      }
      .card-body .mb-3 {
        margin-bottom: 0.75rem;
      }
      /* Bloktitels in hoofdletters */
      .block-title {
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 1rem;
      }
      /* Scheidingslijn tussen kolommen */
      .col-divider {
        border-right: 1px solid #ddd;
      }
      .col-divider:last-child {
        border-right: none;
      }
      /* Statische data weergave */
      .form-control-plaintext {
        padding: .375rem .75rem;
        margin-bottom: 0;
        line-height: 1.5;
        color: #212529;
        background-color: #fff;
        border: 1px solid #ced4da;
        border-radius: .25rem;
      }
      /* Opslaan knop rechtsboven */
      .save-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 1050;
      }
      /* Toggle-knoppen (klein) */
      .btn-toggle {
        position: absolute;
        right: 0.5rem;
        bottom: 0.5rem;
      }
      /* Extra blokken: vergrote min-height en geen overflow hidden */
      .extra-block .card-body {
        background-color: #f7f7f7;
        padding: 1rem;
        min-height: 180px;
        overflow: visible;
      }
      /* Styling voor de status-checklist dropdown */
      .dropdown-menu {
        max-height: 200px;
        overflow-y: auto;
      }
      #selectedStatus {
        font-size: 0.85rem;
        color: #555;
      }
      /* Voor standaard producten (bijv. T-shirt) */
      .standardImage {
        max-width: 100%;
        width: 100%;
        display: none;
        margin-top: 1rem;
      }
      /* Tabelkolommen voor specificaties */
      .sizeTable th,
      .sizeTable td {
        vertical-align: middle;
      }
      .col-maat,
      .col-aantal,
      .col-letter {
        width: 10%;
        min-width: 70px;
      }
      .col-omschrijving {
        width: 40%;
      }
      .col-kleur {
        width: 20%;
      }
      /* Bestanden-upload slot styling */
      .bestanden-upload-slot {
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <!-- Navigatiebalk -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="{{ url_for('index') }}">Teamwear & Drukwerk</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="{{ url_for('index') }}">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('add_customer') }}">Nieuwe Klant</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('list_customers') }}">Klantenlijst</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('add_assignment') }}">Nieuwe Opdracht</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('list_assignments') }}">Opdrachten</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('list_billing_infos') }}">Factuurgegevens</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container mt-5 position-relative">
      <h1>{% if assignment %}Bewerk Opdracht{% else %}Nieuwe Opdracht{% endif %}</h1>
      <!-- Opslaan knop -->
      <button type="submit" form="editCustomerForm" class="btn btn-primary save-btn">Opslaan</button>
      
      <!-- (Optioneel) Verborgen input voor extra verwerking -->
      <input type="hidden" name="items_data" id="items_data" value="{{ items_data if items_data else '' }}">

      <!-- Zoekbalk -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="mb-3 position-relative">
            <label for="customer_search" class="form-label">Zoek Klant:</label>
            <input type="text" class="form-control" id="customer_search" name="customer_search" placeholder="Typ naam, e-mail, vereniging, referentie of bedrijfsnaam" autocomplete="off">
            <div id="customerSuggestions"></div>
          </div>
        </div>
      </div>

      <!-- Hoofdblokken -->
      <div class="blocks-section">
        <form method="post" id="editCustomerForm" enctype="multipart/form-data">
          <div class="row">
            <!-- Opdrachtgever -->
            <div class="col-md-4 col-divider mb-4">
              <div class="card shadow-sm">
                <div class="card-body" id="leftBlockContent">
                  <h3 class="block-title">Opdrachtgever</h3>
                  <div class="mb-3">
                    <label class="form-label">Naam:</label>
                    <p id="nameDisplay" class="form-control-plaintext">{{ assignment.customer.name if assignment and assignment.customer else "" }}</p>
                    <input type="hidden" id="name" name="name" value="{{ assignment.customer.name if assignment and assignment.customer else "" }}">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Email:</label>
                    <p id="emailDisplay" class="form-control-plaintext">{{ assignment.customer.email if assignment and assignment.customer else "" }}</p>
                    <input type="hidden" id="email" name="email" value="{{ assignment.customer.email if assignment and assignment.customer else "" }}">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Telefoonnummer:</label>
                    <p id="telefoonDisplay" class="form-control-plaintext">{{ assignment.customer.telefoon if assignment and assignment.customer else "" }}</p>
                    <input type="hidden" id="telefoon" name="telefoon" value="{{ assignment.customer.telefoon if assignment and assignment.customer else "" }}">
                  </div>
                  <input type="hidden" id="customer_id" name="customer_id" value="{{ assignment.customer.id if assignment and assignment.customer else "" }}">
                </div>
              </div>
            </div>

            <!-- Factuurgegevens -->
            <div class="col-md-4 col-divider mb-4">
              <div class="card shadow-sm">
                <div class="card-body" id="middleBlockContent">
                  <h3 class="block-title">Factuurgegevens</h3>
                  <div class="mb-3">
                    <label class="form-label">Naam:</label>
                    <p id="factuur_naamDisplay" class="form-control-plaintext">{{ assignment.customer.billing_info.name if assignment and assignment.customer and assignment.customer.billing_info else "" }}</p>
                    <input type="hidden" id="factuur_naam" name="factuur_naam" value="{{ assignment.customer.billing_info.name if assignment and assignment.customer and assignment.customer.billing_info else "" }}">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Bedrijfsnaam:</label>
                    <p id="factuur_companynameDisplay" class="form-control-plaintext">{{ assignment.customer.billing_info.companyname if assignment and assignment.customer and assignment.customer.billing_info else "" }}</p>
                    <input type="hidden" id="factuur_companyname" name="factuur_companyname" value="{{ assignment.customer.billing_info.companyname if assignment and assignment.customer and assignment.customer.billing_info else "" }}">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Adres:</label>
                    <p id="factuur_adresDisplay" class="form-control-plaintext">{{ assignment.customer.billing_info.address if assignment and assignment.customer and assignment.customer.billing_info else "" }}</p>
                    <input type="hidden" id="factuur_adres" name="factuur_adres" value="{{ assignment.customer.billing_info.address if assignment and assignment.customer and assignment.customer.billing_info else "" }}">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Postcode:</label>
                    <p id="factuur_postcodeDisplay" class="form-control-plaintext">{{ assignment.customer.billing_info.postcode if assignment and assignment.customer and assignment.customer.billing_info else "" }}</p>
                    <input type="hidden" id="factuur_postcode" name="factuur_postcode" value="{{ assignment.customer.billing_info.postcode if assignment and assignment.customer and assignment.customer.billing_info else "" }}">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Huisnummer:</label>
                    <p id="factuur_huisnummerDisplay" class="form-control-plaintext">{{ assignment.customer.billing_info.housenumber if assignment and assignment.customer and assignment.customer.billing_info else "" }}</p>
                    <input type="hidden" id="factuur_huisnummer" name="factuur_huisnummer" value="{{ assignment.customer.billing_info.housenumber if assignment and assignment.customer and assignment.customer.billing_info else "" }}">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Telefoonnummer:</label>
                    <p id="factuur_telefoonDisplay" class="form-control-plaintext">{{ assignment.customer.billing_info.phone if assignment and assignment.customer and assignment.customer.billing_info else "" }}</p>
                    <input type="hidden" id="factuur_telefoon" name="factuur_telefoon" value="{{ assignment.customer.billing_info.phone if assignment and assignment.customer and assignment.customer.billing_info else "" }}">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">E-mail:</label>
                    <p id="factuur_emailDisplay" class="form-control-plaintext">{{ assignment.customer.billing_info.email if assignment and assignment.customer and assignment.customer.billing_info else "" }}</p>
                    <input type="hidden" id="factuur_email" name="factuur_email" value="{{ assignment.customer.billing_info.email if assignment and assignment.customer and assignment.customer.billing_info else "" }}">
                  </div>
                  <button type="button" class="btn btn-sm btn-link btn-toggle" id="toggleMiddle" style="display:none;">Uitvouw</button>
                </div>
              </div>
            </div>

            <!-- Vereniging -->
            <div class="col-md-4 mb-4">
              <div class="card shadow-sm">
                <div class="card-body" id="rightBlockContent">
                  <h3 class="block-title">Vereniging</h3>
                  <div class="mb-3">
                    <label class="form-label">Vereniging:</label>
                    <p id="verenigingDisplay" class="form-control-plaintext">{{ assignment.customer.vereniging if assignment and assignment.customer else "" }}</p>
                    <input type="hidden" id="vereniging" name="vereniging" value="{{ assignment.customer.vereniging if assignment and assignment.customer else "" }}">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Referentie:</label>
                    <p id="referentieDisplay" class="form-control-plaintext">{{ assignment.customer.referentie if assignment and assignment.customer else "" }}</p>
                    <input type="hidden" id="referentie" name="referentie" value="{{ assignment.customer.referentie if assignment and assignment.customer else "" }}">
                  </div>
                  <button type="button" class="btn btn-sm btn-link btn-toggle" id="toggleRight" style="display:none;">Uitvouw</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Extra rij met vrije invulvelden -->
          <div class="row">
            <!-- Status opdracht -->
            <div class="col-md-4 col-divider mb-4 extra-block">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h3 class="block-title">Status opdracht</h3>
                  <div class="dropdown mb-2">
                    <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="statusDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                      Selecteer status
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="statusDropdown">
                      <li class="px-3">
                        <div class="form-check">
                          <input class="form-check-input status-option" type="checkbox" value="order besteld" id="status1">
                          <label class="form-check-label" for="status1">order besteld</label>
                        </div>
                      </li>
                      <li class="px-3">
                        <div class="form-check">
                          <input class="form-check-input status-option" type="checkbox" value="order geleverd" id="status2">
                          <label class="form-check-label" for="status2">order geleverd</label>
                        </div>
                      </li>
                      <li class="px-3">
                        <div class="form-check">
                          <input class="form-check-input status-option" type="checkbox" value="order compleet" id="status3">
                          <label class="form-check-label" for="status3">order compleet</label>
                        </div>
                      </li>
                      <li><hr class="dropdown-divider"></li>
                      <li class="px-3">
                        <div class="form-check">
                          <input class="form-check-input status-option" type="checkbox" value="drukwerk voorbereid" id="status4">
                          <label class="form-check-label" for="status4">drukwerk voorbereid</label>
                        </div>
                      </li>
                      <li class="px-3">
                        <div class="form-check">
                          <input class="form-check-input status-option" type="checkbox" value="aan het drukken" id="status5">
                          <label class="form-check-label" for="status5">aan het drukken</label>
                        </div>
                      </li>
                      <li class="px-3">
                        <div class="form-check">
                          <input class="form-check-input status-option" type="checkbox" value="drukwerk afgerond" id="status6">
                          <label class="form-check-label" for="status6">drukwerk afgerond</label>
                        </div>
                      </li>
                      <li class="px-3">
                        <div class="form-check">
                          <input class="form-check-input status-option" type="checkbox" value="gecontroleerd" id="status7">
                          <label class="form-check-label" for="status7">gecontroleerd</label>
                        </div>
                      </li>
                      <li><hr class="dropdown-divider"></li>
                      <li class="px-3">
                        <div class="form-check">
                          <input class="form-check-input status-option" type="checkbox" value="offerte gestuurd" id="status8">
                          <label class="form-check-label" for="status8">offerte gestuurd</label>
                        </div>
                      </li>
                      <li class="px-3">
                        <div class="form-check">
                          <input class="form-check-input status-option" type="checkbox" value="voorbeelden gestuurd" id="status9">
                          <label class="form-check-label" for="status9">voorbeelden gestuurd</label>
                        </div>
                      </li>
                      <li class="px-3">
                        <div class="form-check">
                          <input class="form-check-input status-option" type="checkbox" value="factuur gestuurd" id="status10">
                          <label class="form-check-label" for="status10">factuur gestuurd</label>
                        </div>
                      </li>
                      <li class="px-3">
                        <div class="form-check">
                          <input class="form-check-input status-option" type="checkbox" value="klant bericht" id="status11">
                          <label class="form-check-label" for="status11">klant bericht</label>
                        </div>
                      </li>
                      <li class="px-3">
                        <div class="form-check">
                          <input class="form-check-input status-option" type="checkbox" value="volledig afgerond" id="status12">
                          <label class="form-check-label" for="status12">volledig afgerond</label>
                        </div>
                      </li>
                    </ul>
                  </div>
                  <div id="selectedStatus" class="mb-3">{{ assignment.status_opdracht if assignment and assignment.status_opdracht else "" }}</div>
                  <input type="hidden" id="status_opdracht" name="status_opdracht" value="{{ assignment.status_opdracht if assignment and assignment.status_opdracht else "" }}">
                </div>
              </div>
            </div>

            <!-- Deadline -->
            <div class="col-md-4 col-divider mb-4 extra-block">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h3 class="block-title">Deadline</h3>
                  <div class="mb-3">
                    <input type="date" class="form-control" id="deadline" name="deadline" value="{{ assignment.deadline.strftime('%Y-%m-%d') if assignment and assignment.deadline else '' }}">
                  </div>
                </div>
              </div>
            </div>

            <!-- Opmerkingen -->
            <div class="col-md-4 mb-4 extra-block">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h3 class="block-title">Opmerkingen</h3>
                  <div class="mb-3">
                    <textarea class="form-control" id="opmerkingen" name="opmerkingen" rows="3" placeholder="Voer hier eventuele opmerkingen in">{{ assignment.opmerkingen if assignment and assignment.opmerkingen else "" }}</textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- DYNAMISCHE SECTIES (PRODUCTEN) -->
          <div class="row">
            <div class="col-12">
              <!-- Container voor toegevoegde secties -->
              <div id="itemsContainer" class="mt-4"></div>

              <!-- Template (verborgen) voor een nieuwe sectie -->
              <div id="itemSectionTemplate" style="display: none;">
                <!-- Deze template wordt gebruikt voor alle itemtypes behalve "voorbeelden", "bestanden" en "overig" -->
                <div class="card shadow-sm my-3">
                  <div class="card-body">
                    <h3 class="block-title">[ITEM TYPE]</h3>
                    <!-- Hidden input voor het itemtype -->
                    <input type="hidden" name="item_type[]" value="[ITEM TYPE]">
                    <div class="row">
                      <!-- Kolom 1: Productafbeelding -->
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label class="form-label">Productafbeelding:</label>
                          <div class="d-flex align-items-center">
                            <input type="file" class="form-control productImageUpload" accept="image/*" style="width: auto; min-width: 160px; margin-right: 10px;" name="item_file[]">
                            <img src="" alt="Preview" class="img-fluid previewImage" style="display:none; max-width:120px;">
                          </div>
                        </div>
                        <div>
                          <img src="" alt="Standaard afbeelding" class="img-fluid standardImage">
                        </div>
                      </div>
                      <!-- Kolom 2: Gegevens en specificaties -->
                      <div class="col-md-8">
                        <!-- Gegevens boven de tabel (alleen binnen deze kolom) -->
                        <div class="row mb-3">
                          <div class="col-md-6">
                            <label class="form-label">Merk:</label>
                            <input type="text" class="form-control" placeholder="Merk" name="item_merk[]">
                            <label class="form-label mt-3">Artikelomschrijving:</label>
                            <input type="text" class="form-control" placeholder="Artikelomschrijving" name="item_artikelomschrijving[]">
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">Artikelnummer:</label>
                            <input type="text" class="form-control" placeholder="Artikelnummer" name="item_artikelnummer[]">
                            <label class="form-label mt-3">Prijs:</label>
                            <input type="text" class="form-control" placeholder="Prijs" name="item_prijs[]">
                          </div>
                        </div>
                        <!-- Tabel met specificaties -->
                        <table class="table table-bordered align-middle mb-3 sizeTable">
                          <thead>
                            <tr>
                              <th class="col-maat">Maat</th>
                              <th class="col-aantal">Aantal</th>
                              <th class="col-letter">Letter</th>
                              <th class="col-omschrijving">Omschrijving</th>
                              <th class="col-kleur">Kleur</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                              <td><input type="text" class="form-control" placeholder="Bijv. S, M, 152" name="item_maat[]"></td>
                              <td><input type="number" class="form-control" placeholder="Aantal..." name="item_aantal[]"></td>
                              <td><input type="text" class="form-control" placeholder="Bijv. A" name="item_letter[]"></td>
                              <td><input type="text" class="form-control" placeholder="Drukwerk omschrijving" name="item_omschrijving[]"></td>
                              <td><input type="text" class="form-control" placeholder="Kleur" name="item_kleur[]"></td>
                            </tr>
                          </tbody>
                        </table>
                        <button type="button" class="btn btn-sm btn-secondary addSizeRowBtn">+ Maat toevoegen</button>
                      </div>
                    </div>
                    <div class="text-end mt-3">
                      <button type="button" class="btn btn-sm btn-danger removeItemBtn">Verwijder sectie</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Plusknop met dropdown -->
              <div class="dropdown my-3">
                <button class="btn btn-primary dropdown-toggle" type="button" id="addNewItemBtn" data-bs-toggle="dropdown" aria-expanded="false">
                  + Item toevoegen
                </button>
                <ul class="dropdown-menu" aria-labelledby="addNewItemBtn" id="itemOptionsMenu">
                  <li><a class="dropdown-item" href="#" data-itemtype="T-shirt">T-shirt</a></li>
                  <li><a class="dropdown-item" href="#" data-itemtype="Trui">Trui</a></li>
                  <li><a class="dropdown-item" href="#" data-itemtype="Vest">Vest</a></li>
                  <li><a class="dropdown-item" href="#" data-itemtype="Trui korte rits">Trui korte rits</a></li>
                  <li><a class="dropdown-item" href="#" data-itemtype="Korte broek">Korte broek</a></li>
                  <li><a class="dropdown-item" href="#" data-itemtype="Lange broek">Lange broek</a></li>
                  <li><a class="dropdown-item" href="#" data-itemtype="Tas">Tas</a></li>
                  <li><a class="dropdown-item" href="#" data-itemtype="overig">overig</a></li>
                  <li><a class="dropdown-item" href="#" data-itemtype="voorbeelden">voorbeelden</a></li>
                  <li><a class="dropdown-item" href="#" data-itemtype="bestanden">bestanden</a></li>
                </ul>
              </div>
              <!-- EINDE dynamische items -->
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Script -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      // A) Hoogte/Uitvouwen van blokken
      function recalcHeights() {
        var leftBlock = document.getElementById('leftBlockContent');
        if (!leftBlock) return;
        var middleBlock = document.getElementById('middleBlockContent');
        var rightBlock = document.getElementById('rightBlockContent');
        var leftHeight = leftBlock.offsetHeight;
        middleBlock.style.height = leftHeight + 'px';
        rightBlock.style.height = leftHeight + 'px';
        if (middleBlock.scrollHeight > leftHeight) {
          document.getElementById('toggleMiddle').style.display = 'block';
          document.getElementById('toggleMiddle').textContent = 'Uitvouw';
        } else {
          document.getElementById('toggleMiddle').style.display = 'none';
        }
        if (rightBlock.scrollHeight > leftHeight) {
          document.getElementById('toggleRight').style.display = 'block';
          document.getElementById('toggleRight').textContent = 'Uitvouw';
        } else {
          document.getElementById('toggleRight').style.display = 'none';
        }
      }
      window.addEventListener('resize', recalcHeights);
      let toggleMiddle = document.getElementById('toggleMiddle');
      if (toggleMiddle) {
        toggleMiddle.addEventListener('click', function() {
          var middleBlock = document.getElementById('middleBlockContent');
          if (middleBlock.style.height !== 'auto') {
            middleBlock.style.height = 'auto';
            this.textContent = 'Inklappen';
          } else {
            recalcHeights();
            this.textContent = 'Uitvouw';
          }
        });
      }
      let toggleRight = document.getElementById('toggleRight');
      if (toggleRight) {
        toggleRight.addEventListener('click', function() {
          var rightBlock = document.getElementById('rightBlockContent');
          if (rightBlock.style.height !== 'auto') {
            rightBlock.style.height = 'auto';
            this.textContent = 'Inklappen';
          } else {
            recalcHeights();
            this.textContent = 'Uitvouw';
          }
        });
      }

      // B) Klant zoeken
      var customerInfos = {};
      {% for customer in customers %}
        {% set search_key = customer.name ~ " - " ~ customer.email ~ " - " ~ (customer.vereniging or "") ~ " - " ~ (customer.referentie or "") ~ " - " ~ (customer.billing_info.companyname if customer.billing_info and customer.billing_info.companyname else "") %}
        customerInfos[{{ search_key|tojson|safe }}] = {
          id: {{ customer.id|tojson|safe }},
          name: {{ customer.name|tojson|safe }},
          email: {{ customer.email|tojson|safe }},
          telefoon: {{ customer.telefoon|tojson if customer.telefoon else '""'|safe }},
          billing: {
            name: {{ customer.billing_info.name|tojson|safe if customer.billing_info and customer.billing_info.name else '""'|safe }},
            companyname: {{ customer.billing_info.companyname|tojson|safe if customer.billing_info and customer.billing_info.companyname else '""'|safe }},
            address: {{ customer.billing_info.address|tojson|safe if customer.billing_info and customer.billing_info.address else '""'|safe }},
            postcode: {{ customer.billing_info.postcode|tojson|safe if customer.billing_info and customer.billing_info.postcode else '""'|safe }},
            housenumber: {{ customer.billing_info.housenumber|tojson|safe if customer.billing_info and customer.billing_info.housenumber else '""'|safe }},
            phone: {{ customer.billing_info.phone|tojson|safe if customer.billing_info and customer.billing_info.phone else '""'|safe }},
            email: {{ customer.billing_info.email|tojson|safe if customer.billing_info and customer.billing_info.email else '""'|safe }}
          },
          vereniging: {{ customer.vereniging|default('')|tojson|safe }},
          referentie: {{ customer.referentie|default('')|tojson|safe }}
        };
      {% endfor %}
      var customerSearchInput = document.getElementById('customer_search');
      var customerSuggestions = document.getElementById('customerSuggestions');
      if (customerSearchInput) {
        customerSearchInput.addEventListener('input', function() {
          var query = this.value.toLowerCase();
          customerSuggestions.innerHTML = '';
          if (query.length === 0) {
            customerSuggestions.style.display = 'none';
            return;
          }
          var matches = [];
          for (var key in customerInfos) {
            if (key.toLowerCase().indexOf(query) !== -1) {
              matches.push(key);
            }
          }
          if (matches.length > 0) {
            customerSuggestions.style.display = 'block';
            matches.forEach(function(match) {
              var div = document.createElement('div');
              div.className = 'suggestion-item';
              div.textContent = match;
              div.addEventListener('click', function() {
                customerSearchInput.value = match;
                var info = customerInfos[match];
                document.getElementById('nameDisplay').textContent = info.name;
                document.getElementById('name').value = info.name;
                document.getElementById('emailDisplay').textContent = info.email;
                document.getElementById('email').value = info.email;
                document.getElementById('telefoonDisplay').textContent = info.telefoon;
                document.getElementById('telefoon').value = info.telefoon;
                document.getElementById('customer_id').value = info.id;
                document.getElementById('factuur_naamDisplay').textContent = info.billing.name;
                document.getElementById('factuur_naam').value = info.billing.name;
                document.getElementById('factuur_companynameDisplay').textContent = info.billing.companyname;
                document.getElementById('factuur_companyname').value = info.billing.companyname;
                document.getElementById('factuur_adresDisplay').textContent = info.billing.address;
                document.getElementById('factuur_adres').value = info.billing.address;
                document.getElementById('factuur_postcodeDisplay').textContent = info.billing.postcode;
                document.getElementById('factuur_postcode').value = info.billing.postcode;
                document.getElementById('factuur_huisnummerDisplay').textContent = info.billing.housenumber;
                document.getElementById('factuur_huisnummer').value = info.billing.housenumber;
                document.getElementById('factuur_telefoonDisplay').textContent = info.billing.phone;
                document.getElementById('factuur_telefoon').value = info.billing.phone;
                document.getElementById('factuur_emailDisplay').textContent = info.billing.email;
                document.getElementById('factuur_email').value = info.billing.email;
                document.getElementById('verenigingDisplay').textContent = info.vereniging;
                document.getElementById('vereniging').value = info.vereniging;
                document.getElementById('referentieDisplay').textContent = info.referentie;
                document.getElementById('referentie').value = info.referentie;
                customerSuggestions.style.display = 'none';
                recalcHeights();
              });
              customerSuggestions.appendChild(div);
            });
          } else {
            customerSuggestions.style.display = 'none';
          }
        });
      }

      // C) Status-checklist dropdown
      let statusCheckboxes = document.querySelectorAll('.status-option');
      statusCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
          let selected = [];
          document.querySelectorAll('.status-option:checked').forEach(function(cb) {
            selected.push(cb.value);
          });
          document.getElementById('selectedStatus').textContent = selected.join(', ');
          document.getElementById('status_opdracht').value = selected.join(',');
        });
      });

      // D) Dynamische secties (items)
      const itemsContainer = document.getElementById('itemsContainer');
      const itemSectionTemplate = document.getElementById('itemSectionTemplate');
      const itemOptionsMenu = document.getElementById('itemOptionsMenu');

      itemOptionsMenu.querySelectorAll('a.dropdown-item').forEach(function(menuItem) {
        menuItem.addEventListener('click', function(event) {
          event.preventDefault();
          const itemType = this.getAttribute('data-itemtype');
          let newSection;

          if (itemType === "voorbeelden") {
            newSection = document.createElement('div');
            newSection.innerHTML = `
              <div class="card shadow-sm my-3">
                <div class="card-body">
                  <h3 class="block-title">Voorbeelden</h3>
                  <input type="hidden" name="item_type[]" value="voorbeelden">
                  <div class="row">
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label class="form-label">Upload voorbeeld 1:</label>
                        <input type="file" class="form-control exampleUpload" accept="image/*" name="item_file[]">
                      </div>
                      <div class="mb-3">
                        <img src="" alt="Voorbeeld 1" class="img-fluid examplePreview" style="display:none; width:100%;">
                      </div>
                      <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-secondary removePhotoBtn">Verwijder foto</button>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label class="form-label">Upload voorbeeld 2:</label>
                        <input type="file" class="form-control exampleUpload" accept="image/*" name="item_file[]">
                      </div>
                      <div class="mb-3">
                        <img src="" alt="Voorbeeld 2" class="img-fluid examplePreview" style="display:none; width:100%;">
                      </div>
                      <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-secondary removePhotoBtn">Verwijder foto</button>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label class="form-label">Upload voorbeeld 3:</label>
                        <input type="file" class="form-control exampleUpload" accept="image/*" name="item_file[]">
                      </div>
                      <div class="mb-3">
                        <img src="" alt="Voorbeeld 3" class="img-fluid examplePreview" style="display:none; width:100%;">
                      </div>
                      <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-secondary removePhotoBtn">Verwijder foto</button>
                      </div>
                    </div>
                  </div>
                  <div class="text-end mt-3">
                    <button type="button" class="btn btn-sm btn-danger removeItemBtn">Verwijder sectie</button>
                  </div>
                </div>
              </div>
            `;
            newSection.querySelector('.removeItemBtn').addEventListener('click', function() {
              newSection.remove();
            });
            newSection.querySelectorAll('.exampleUpload').forEach(function(input) {
              let preview = input.closest('.col-md-4').querySelector('.examplePreview');
              input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                  const reader = new FileReader();
                  reader.onload = function(evt) {
                    preview.src = evt.target.result;
                    preview.style.display = "block";
                  };
                  reader.readAsDataURL(file);
                } else {
                  preview.src = "";
                  preview.style.display = "none";
                }
              });
            });
            newSection.querySelectorAll('.removePhotoBtn').forEach(function(btn) {
              btn.addEventListener('click', function(e) {
                let col = e.target.closest('.col-md-4');
                let fileInput = col.querySelector('.exampleUpload');
                let preview = col.querySelector('.examplePreview');
                fileInput.value = "";
                preview.src = "";
                preview.style.display = "none";
              });
            });
          }
          else if (itemType === "bestanden") {
            newSection = document.createElement('div');
            newSection.innerHTML = `
              <div class="card shadow-sm my-3">
                <div class="card-body">
                  <h3 class="block-title">Bestanden</h3>
                  <input type="hidden" name="item_type[]" value="bestanden">
                  <div class="row">
                    ${[1,2,3].map(col => `
                      <div class="col-md-4">
                        <div class="bestanden-upload-slot">
                          <label class="form-label">Upload bestand ${col}:</label>
                          <input type="file" class="form-control bestandenUpload" accept=".eps,.cdr,.pdf,image/*" name="item_file[]">
                          <div class="mt-2">
                            <a href="#" class="btn btn-sm btn-link downloadLink" style="display:none;" download>Download bestand</a>
                            <button type="button" class="btn btn-sm btn-secondary removeFileBtn" style="display:none;">Verwijder bestand</button>
                          </div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                  <div class="text-end mt-3">
                    <button type="button" class="btn btn-sm btn-danger removeItemBtn">Verwijder sectie</button>
                  </div>
                </div>
              </div>
            `;
            newSection.querySelector('.removeItemBtn').addEventListener('click', function() {
              newSection.remove();
            });
            newSection.querySelectorAll('.bestandenUpload').forEach(function(input) {
              let parentSlot = input.closest('.bestanden-upload-slot');
              let downloadLink = parentSlot.querySelector('.downloadLink');
              let removeBtn = parentSlot.querySelector('.removeFileBtn');
              input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                  const url = URL.createObjectURL(file);
                  downloadLink.href = url;
                  downloadLink.textContent = file.name;
                  downloadLink.style.display = "inline-block";
                  removeBtn.style.display = "inline-block";
                } else {
                  downloadLink.href = "#";
                  downloadLink.style.display = "none";
                  removeBtn.style.display = "none";
                }
              });
              removeBtn.addEventListener('click', function() {
                if(downloadLink.href && downloadLink.href !== "#") {
                  URL.revokeObjectURL(downloadLink.href);
                }
                input.value = "";
                downloadLink.href = "#";
                downloadLink.style.display = "none";
                removeBtn.style.display = "none";
              });
            });
          }
          else if (itemType === "overig") {
            newSection = document.createElement('div');
            newSection.innerHTML = `
              <div class="card shadow-sm my-3">
                <div class="card-body">
                  <h3 class="block-title">Overig</h3>
                  <input type="hidden" name="item_type[]" value="overig">
                  <div class="row">
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label class="form-label">Productafbeelding:</label>
                        <div class="d-flex align-items-center">
                          <input type="file" class="form-control productImageUpload" accept="image/*" style="width: auto; min-width: 160px; margin-right: 10px;" name="item_file[]">
                          <img src="" alt="Preview" class="img-fluid previewImage" style="display:none; max-width:120px;">
                        </div>
                      </div>
                      <div>
                        <img src="" alt="Standaard afbeelding" class="img-fluid standardImage">
                      </div>
                    </div>
                    <div class="col-md-8">
                      <div class="mb-3">
                        <label class="form-label">Omschrijving:</label>
                        <input type="text" class="form-control" placeholder="Omschrijving" name="item_omschrijving[]">
                      </div>
                    </div>
                  </div>
                  <div class="text-end mt-3">
                    <button type="button" class="btn btn-sm btn-danger removeItemBtn">Verwijder sectie</button>
                  </div>
                </div>
              </div>
            `;
            newSection.querySelector('.removeItemBtn').addEventListener('click', function() {
              newSection.remove();
            });
            newSection.querySelector('.productImageUpload').addEventListener('change', function(e) {
              const file = e.target.files[0];
              let previewImg = newSection.querySelector('.previewImage');
              if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                  previewImg.src = evt.target.result;
                  previewImg.style.display = "block";
                };
                reader.readAsDataURL(file);
              } else {
                previewImg.src = "";
                previewImg.style.display = "none";
              }
            });
          }
          else {
            newSection = itemSectionTemplate.cloneNode(true);
            newSection.id = "";
            newSection.style.display = "";
            newSection.querySelector('.block-title').textContent = itemType;
            // Update het hidden input voor het itemtype
            newSection.querySelector('input[name="item_type[]"]').value = itemType;
            let removeBtn = newSection.querySelector('.removeItemBtn');
            removeBtn.addEventListener('click', function() {
              newSection.remove();
            });
            let standardImg = newSection.querySelector('.standardImage');
            if (itemType === "T-shirt") {
              standardImg.src = "/static/uploads/img/shirt_front_and_back.jpg";
              standardImg.style.display = "block";
            } else if (itemType === "Trui") {
              standardImg.src = "/static/uploads/img/shirt_lange_mouwen.jpg";
              standardImg.style.display = "block";
            } else if (itemType === "Vest") {
              standardImg.src = "/static/uploads/img/trui_lange_rits.jpg";
              standardImg.style.display = "block";
            } else if (itemType === "Trui korte rits") {
              standardImg.src = "/static/uploads/img/trui_korte_rits.jpg";
              standardImg.style.display = "block";
            } else if (itemType === "Korte broek") {
              standardImg.src = "/static/uploads/img/korte_broek.jpg";
              standardImg.style.display = "block";
            } else if (itemType === "Lange broek") {
              standardImg.src = "/static/uploads/img/lange_broek.jpg";
              standardImg.style.display = "block";
            } else if (itemType === "Tas") {
              standardImg.src = "/static/uploads/img/voetbal_tas.jpg";
              standardImg.style.display = "block";
            } else {
              standardImg.src = "";
              standardImg.style.display = "none";
            }
            let fileInput = newSection.querySelector('.productImageUpload');
            let previewImg = newSection.querySelector('.previewImage');
            fileInput.addEventListener('change', function(e) {
              const file = e.target.files[0];
              if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                  previewImg.src = evt.target.result;
                  previewImg.style.display = "block";
                };
                reader.readAsDataURL(file);
              } else {
                previewImg.src = "";
                previewImg.style.display = "none";
              }
            });
            let addSizeRowBtn = newSection.querySelector('.addSizeRowBtn');
            if(addSizeRowBtn){
              let sizeTableBody = newSection.querySelector('.sizeTable tbody');
              addSizeRowBtn.addEventListener('click', function() {
                let tr = document.createElement('tr');
                let tdMaat = document.createElement('td');
                let inputMaat = document.createElement('input');
                inputMaat.type = "text";
                inputMaat.placeholder = "Bijv. S, M, 152...";
                inputMaat.className = "form-control";
                inputMaat.name = "item_maat[]";
                tdMaat.appendChild(inputMaat);
                let tdAantal = document.createElement('td');
                let inputAantal = document.createElement('input');
                inputAantal.type = "number";
                inputAantal.placeholder = "Aantal...";
                inputAantal.className = "form-control";
                inputAantal.name = "item_aantal[]";
                tdAantal.appendChild(inputAantal);
                let tdLetter = document.createElement('td');
                let inputLetter = document.createElement('input');
                inputLetter.type = "text";
                inputLetter.placeholder = "Bijv. A";
                inputLetter.className = "form-control";
                inputLetter.name = "item_letter[]";
                tdLetter.appendChild(inputLetter);
                let tdOmsch = document.createElement('td');
                let inputOmsch = document.createElement('input');
                inputOmsch.type = "text";
                inputOmsch.placeholder = "Drukwerk omschrijving";
                inputOmsch.className = "form-control";
                inputOmsch.name = "item_omschrijving[]";
                tdOmsch.appendChild(inputOmsch);
                let tdKleur = document.createElement('td');
                let inputKleur = document.createElement('input');
                inputKleur.type = "text";
                inputKleur.placeholder = "Kleur";
                inputKleur.className = "form-control";
                inputKleur.name = "item_kleur[]";
                tdKleur.appendChild(inputKleur);
                tr.appendChild(tdMaat);
                tr.appendChild(tdAantal);
                tr.appendChild(tdLetter);
                tr.appendChild(tdOmsch);
                tr.appendChild(tdKleur);
                sizeTableBody.appendChild(tr);
              });
            }
          }
          itemsContainer.appendChild(newSection);
          newSection.scrollIntoView({ behavior: "smooth" });
        });
      });

      // E) Laad bestaande dynamische items (indien aanwezig)
      function loadDynamicItems() {
        const itemsDataInput = document.getElementById('items_data');
        if (!itemsDataInput.value) return;
        let items;
        try {
          items = JSON.parse(itemsDataInput.value);
        } catch(e) {
          console.error("Invalid items_data JSON", e);
          return;
        }
        items.forEach(function(item) {
          let newSection;
          const itemType = item.type;
          newSection = itemSectionTemplate.cloneNode(true);
          newSection.id = "";
          newSection.style.display = "";
          newSection.querySelector('.block-title').textContent = itemType;
          newSection.querySelector('input[name="item_type[]"]').value = itemType;
          let removeBtn = newSection.querySelector('.removeItemBtn');
          removeBtn.addEventListener('click', function() {
            newSection.remove();
          });
          let standardImg = newSection.querySelector('.standardImage');
          if (itemType === "T-shirt") {
            standardImg.src = "/static/uploads/img/shirt_front_and_back.jpg";
            standardImg.style.display = "block";
          } else if (itemType === "Trui") {
            standardImg.src = "/static/uploads/img/shirt_lange_mouwen.jpg";
            standardImg.style.display = "block";
          } else if (itemType === "Vest") {
            standardImg.src = "/static/uploads/img/trui_lange_rits.jpg";
            standardImg.style.display = "block";
          } else if (itemType === "Trui korte rits") {
            standardImg.src = "/static/uploads/img/trui_korte_rits.jpg";
            standardImg.style.display = "block";
          } else if (itemType === "Korte broek") {
            standardImg.src = "/static/uploads/img/korte_broek.jpg";
            standardImg.style.display = "block";
          } else if (itemType === "Lange broek") {
            standardImg.src = "/static/uploads/img/lange_broek.jpg";
            standardImg.style.display = "block";
          } else if (itemType === "Tas") {
            standardImg.src = "/static/uploads/img/voetbal_tas.jpg";
            standardImg.style.display = "block";
          } else {
            standardImg.src = "";
            standardImg.style.display = "none";
          }
          let fileInput = newSection.querySelector('.productImageUpload');
          let previewImg = newSection.querySelector('.previewImage');
          fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function(evt) {
                previewImg.src = evt.target.result;
                previewImg.style.display = "block";
              };
              reader.readAsDataURL(file);
            } else {
              previewImg.src = "";
              previewImg.style.display = "none";
            }
          });
          let addSizeRowBtn = newSection.querySelector('.addSizeRowBtn');
          if(addSizeRowBtn){
            let sizeTableBody = newSection.querySelector('.sizeTable tbody');
            addSizeRowBtn.addEventListener('click', function() {
              let tr = document.createElement('tr');
              let tdMaat = document.createElement('td');
              let inputMaat = document.createElement('input');
              inputMaat.type = "text";
              inputMaat.placeholder = "Bijv. S, M, 152...";
              inputMaat.className = "form-control";
              inputMaat.name = "item_maat[]";
              tdMaat.appendChild(inputMaat);
              let tdAantal = document.createElement('td');
              let inputAantal = document.createElement('input');
              inputAantal.type = "number";
              inputAantal.placeholder = "Aantal...";
              inputAantal.className = "form-control";
              inputAantal.name = "item_aantal[]";
              tdAantal.appendChild(inputAantal);
              let tdLetter = document.createElement('td');
              let inputLetter = document.createElement('input');
              inputLetter.type = "text";
              inputLetter.placeholder = "Bijv. A";
              inputLetter.className = "form-control";
              inputLetter.name = "item_letter[]";
              tdLetter.appendChild(inputLetter);
              let tdOmsch = document.createElement('td');
              let inputOmsch = document.createElement('input');
              inputOmsch.type = "text";
              inputOmsch.placeholder = "Drukwerk omschrijving";
              inputOmsch.className = "form-control";
              inputOmsch.name = "item_omschrijving[]";
              tdOmsch.appendChild(inputOmsch);
              let tdKleur = document.createElement('td');
              let inputKleur = document.createElement('input');
              inputKleur.type = "text";
              inputKleur.placeholder = "Kleur";
              inputKleur.className = "form-control";
              inputKleur.name = "item_kleur[]";
              tdKleur.appendChild(inputKleur);
              tr.appendChild(tdMaat);
              tr.appendChild(tdAantal);
              tr.appendChild(tdLetter);
              tr.appendChild(tdOmsch);
              tr.appendChild(tdKleur);
              sizeTableBody.appendChild(tr);
            });
          }
          // Vul de standaardvelden in: merk, artikelomschrijving, artikelnummer, prijs
          if(item.merk) {
            let merkInput = newSection.querySelector('input[placeholder="Merk"]');
            if(merkInput) {
              merkInput.value = item.merk;
            }
          }
          if(item.artikelOmschrijving) {
            let artikelInput = newSection.querySelector('input[placeholder="Artikelomschrijving"]');
            if(artikelInput) {
              artikelInput.value = item.artikelOmschrijving;
            }
          }
          if(item.artikelnummer) {
            let artikelnummerInput = newSection.querySelector('input[placeholder="Artikelnummer"]');
            if(artikelnummerInput) {
              artikelnummerInput.value = item.artikelnummer;
            }
          }
          if(item.prijs) {
            let prijsInput = newSection.querySelector('input[placeholder="Prijs"]');
            if(prijsInput) {
              prijsInput.value = item.prijs;
            }
          }
          // Vul de specificatietabel in via de JSON "specs"
          if(item.specs) {
            try {
              let specs = JSON.parse(item.specs);
              // We gaan ervan uit dat er één rij is in de tabel; pas dit aan als meerdere rijen mogelijk zijn.
              let maatInput = newSection.querySelector('input[name="item_maat[]"]');
              let aantalInput = newSection.querySelector('input[name="item_aantal[]"]');
              let letterInput = newSection.querySelector('input[name="item_letter[]"]');
              let omschrijvingInput = newSection.querySelector('input[name="item_omschrijving[]"]');
              let kleurInput = newSection.querySelector('input[name="item_kleur[]"]');
              if(maatInput) maatInput.value = specs.maat || "";
              if(aantalInput) aantalInput.value = specs.aantal || "";
              if(letterInput) letterInput.value = specs.letter || "";
              if(omschrijvingInput) omschrijvingInput.value = specs.omschrijving || "";
              if(kleurInput) kleurInput.value = specs.kleur || "";
            } catch(e) {
              console.error("Error parsing specs JSON", e);
            }
          }
          // Toon preview als er al een bestand is opgeslagen
          if(item.file) {
            previewImg.src = '/static/uploads/' + item.file;
            previewImg.style.display = "block";
          }
          itemsContainer.appendChild(newSection);
        });
      }

      // Laad bestaande dynamische items (indien aanwezig)
      loadDynamicItems();

      recalcHeights();
    });
    </script>
  </body>
</html>
